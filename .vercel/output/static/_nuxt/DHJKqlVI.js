const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./CHpelNKk.js","./BjEoFfsU.js","./entry.BsuiSp1O.css"])))=>i.map(i=>d[i]);
import{_ as p}from"./BjEoFfsU.js";import{c as d,d as w,m as h,t as u}from"./l51c8n8w.js";async function b(t,e){return await $fetch(`/api/content/${e}/database.sql`,{context:{},responseType:"text",headers:{"content-type":"text/plain"},query:{v:d[String(e)],t:void 0}})}async function g(t,e="gzip"){const n=Uint8Array.from(atob(t),c=>c.charCodeAt(0)),o=new Response(new Blob([n])).body?.pipeThrough(new DecompressionStream(e));return(await new Response(o).text()).split(`
`)}function l(t,e){const n=S(t),a={...e};for(const o of n)a[o]&&a[o]!=="undefined"&&(a[o]=JSON.parse(a[o]));for(const o in a)a[o]==="NULL"&&(a[o]=void 0);return a}function S(t){const e=t.match(/FROM\s+(\w+)/);return e?w[y(e[1])]?.jsonFields||[]:[]}function y(t){return t.replace(/^_content_/,"")}let r;function x(t){return{all:async(e,n)=>(await f(t),r.exec({sql:e,bind:n,rowMode:"object",returnValue:"resultRows"}).map(a=>l(e,a))),first:async(e,n)=>(await f(t),l(e,r.exec({sql:e,bind:n,rowMode:"object",returnValue:"resultRows"}).shift())),exec:async e=>{await f(t),await r.exec({sql:e})}}}async function f(t){const e=h();if(!r){const s=await(await p(()=>import("./CHpelNKk.js"),__vite__mapDeps([0,1,2]),import.meta.url).then(m=>m.default))();e.tick("Import SQLite Module"),r=new s.oo1.DB}if(window.sessionStorage.getItem("previewToken"))return r;let n=null;const a=`checksum_${t}`,o=`collection_${t}`;let i="matched";try{r.exec({sql:`SELECT * FROM ${u.info} where id = '${a}'`,rowMode:"object",returnValue:"resultRows"}).shift()?.version!==d[String(t)]&&(i="mismatch")}catch{i="missing"}if(i!=="matched"){if(window.localStorage.getItem(`content_${a}`)===d[String(t)]&&(n=window.localStorage.getItem(`content_${o}`)),e.tick("Get Local Cache"),!n){n=await b(void 0,String(t)),e.tick("Download Database");{try{window.localStorage.setItem(`content_${a}`,d[String(t)]),window.localStorage.setItem(`content_${o}`,n)}catch(s){console.error("Database integrity check failed, rebuilding database",s)}e.tick("Store Database")}}const c=await g(n);e.tick("Decompress Database"),await r.exec({sql:`DROP TABLE IF EXISTS ${u[String(t)]}`}),i==="mismatch"&&await r.exec({sql:`DELETE FROM ${u.info} WHERE id = '${a}'`});for(const s of c)try{await r.exec(s)}catch(m){console.error("Error executing command",m)}e.tick("Restore Dump")}return e.end("Database Loaded"),r}export{x as loadDatabaseAdapter};
